rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Clean production system: Firebase Auth for teachers + unauthenticated for students
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAuthenticatedTeacher() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Users collection - teachers use Firebase Auth, students are managed by teachers
    match /users/{userId} {
      // Allow unauthenticated read for student game joining (students don't have auth)
      allow read: if request.auth == null;
      
      // Authenticated teachers can manage all users
      allow read, write: if isAuthenticatedTeacher();
      
      // Authenticated teachers can read/update their own profile
      allow read, update: if isSignedIn() && request.auth.uid == userId;
      
      // Allow creation of new teacher profiles during Firebase Auth registration
      allow create: if isSignedIn() && 
                   request.auth.uid == userId &&
                   request.resource.data.isAdmin == true;
      
      // Allow authenticated teachers to query the users collection for statistics
      allow list: if isAuthenticatedTeacher();
    }
    
    // Games collection - teachers manage, students can read and update for joining
    match /games/{gameId} {
      // Students need to read games to join with codes
      // Also allow authenticated users to read for cleanup operations
      allow read: if true;
      
      // Allow students to update games when joining (but not create/delete)
      allow update: if request.auth == null;
      
      // Only authenticated teachers can create/delete games and manage them fully
      allow create, delete: if isAuthenticatedTeacher();
      allow write: if isAuthenticatedTeacher();
      
      // Allow authenticated teachers to query games collection
      allow list: if isAuthenticatedTeacher();
      
      // Word generation logs subcollection - allow creation for logging, teachers can read/delete
      match /word_generation_logs/{logId} {
        allow create: if true; // Allow creation from any context during word generation
        allow read, list, delete: if isAuthenticatedTeacher();
      }
      
      // Analytics subcollection - allow creation for logging, teachers can read/delete  
      match /analytics/{analyticsId} {
        allow create: if true; // Allow creation from any context during analytics
        allow read, list, delete: if isAuthenticatedTeacher();
      }
    }
    
    // GameStates collection - used for active gameplay
    match /gameStates/{stateId} {
      // Students need to read/write game states during gameplay
      allow read, write: if request.auth == null;
      
      // Allow delete for cleanup operations (both authenticated and unauthenticated)
      // This is needed for maintenance to remove orphaned states
      allow delete: if true;
      
      // Authenticated teachers can read/write/delete for management
      allow read, write: if isAuthenticatedTeacher();
      
      // Allow listing gameStates collection for cleanup operations
      // This is needed for maintenance operations to find orphaned states
      allow list: if true;
    }
    
    // WordLists collection - teachers manage, students can read
    match /wordLists/{listId} {
      // Students need to read word lists during games
      allow read: if request.auth == null;
      
      // Only authenticated teachers can create/modify/delete word lists
      allow write: if isAuthenticatedTeacher();
      
      // Allow authenticated teachers to query word lists collection
      allow list: if isAuthenticatedTeacher();
    }
    
    // Analytics and logging collections
    match /word_generation_logs/{logId} {
      // Allow creating logs from the app (both authenticated and unauthenticated)
      allow create: if true;
      
      // Only authenticated teachers can read logs for analytics
      allow read, list: if isAuthenticatedTeacher();
    }
    
    match /word_generation_analytics/{analyticsId} {
      // Allow creating analytics from the app (both authenticated and unauthenticated)
      allow create: if true;
      
      // Only authenticated teachers can read analytics
      allow read, list: if isAuthenticatedTeacher();
    }
    
    match /teacher_usage_analytics/{usageId} {
      // Allow creating usage analytics from the app (both authenticated and unauthenticated)
      allow create: if true;
      
      // Only authenticated teachers can read usage analytics
      allow read, list: if isAuthenticatedTeacher();
    }
    
    // Block access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}